<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>DSU ì¹œêµ¬ ëœë¤ ë§¤ì¹­ ì±„íŒ…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- SockJS & Stomp.js -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <!-- particles.js -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Pretendard:wght@400;600;800&display=swap');
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    body {
      min-height: 100vh;
      width: 100vw;
      background: linear-gradient(120deg, #e6e7ff 0%, #ffe3ee 100%);
      font-family: 'Pretendard', 'Montserrat', Arial, sans-serif;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #particles-js {
      position: fixed;
      width: 100vw;
      height: 100vh;
      left: 0; top: 0;
      z-index: 1;
      pointer-events: none;
      opacity: 0.55;
    }
    .main-wrap {
      z-index: 2;
      width: 100vw;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      left: 0; top: 0;
      pointer-events: none;
    }
    .center-content {
      width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }
    .mini-title {
      font-family: 'Montserrat', Pretendard, Arial, sans-serif;
      color: #9d60db;
      font-size: 1.32rem;
      font-weight: 900;
      letter-spacing: 1.2px;
      margin-bottom: 36px;
      text-align: center;
      text-shadow: 0 3px 14px #c6b6e620;
      line-height: 1.1;
      user-select: none;
      background: none;
      pointer-events: auto;
    }
    /* ë§¤ì¹­, ë§¤ì¹­ëŒ€ê¸° - íˆ¬ëª… */
    #match-div, #matching-div {
      background: none;
      border-radius: 0;
      box-shadow: none;
      width: 700px;
      min-width: 480px;
      min-height: 0;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0;
      position: static;
      transition: none;
    }
    #match-div { animation: fadeInUp 1.05s cubic-bezier(.13,.73,.61,.91);}
    @keyframes fadeInUp {0%{opacity:0; transform:translateY(80px);} 100%{opacity:1; transform:none;}}
    #matchBtn {
      background: linear-gradient(93deg, #ffb6b9 0%, #b56edc 100%);
      color: #fff;
      border: none;
      font-size: 1.25rem;
      font-weight: 800;
      padding: 24px 140px;
      border-radius: 2.5rem;
      margin-top: 0;
      letter-spacing: 1.3px;
      cursor: pointer;
      box-shadow: 0 7px 38px #debfff1a, 0 3px 12px #bfa8ee13;
      transition: background 0.16s, transform 0.11s, box-shadow 0.14s, opacity 0.12s;
      font-family: 'Montserrat', Pretendard, Arial, sans-serif;
      outline: none;
      animation: fadeInUp 1.1s cubic-bezier(.17,.67,.83,.67);
      user-select: none;
    }
    #matchBtn:hover {
      background: linear-gradient(93deg, #b56edc 0%, #ffb6b9 100%);
      transform: scale(1.045) translateY(-3px);
      box-shadow: 0 10px 40px #bfa8ee36;
    }
    #matchBtn:disabled { opacity: 0.65; cursor: not-allowed; transform: none; }

    #matching-div {
      justify-content: center;
      animation: fadeInUp 1.2s;
      padding-top: 0;
      padding-bottom: 0;
      min-height: 0;
    }
    .matching-wait-icon {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100px; height: 100px;
      background: linear-gradient(135deg, #ffe6f7 50%, #e6bbfe 100%);
      border-radius: 50%;
      margin: 0 auto 38px auto;
      box-shadow: 0 4px 24px #c4a7ef18;
      font-size: 3.3rem;
      color: #b56edc;
      animation: popIn 1s cubic-bezier(.19,.68,.83,.67);
    }
    @keyframes popIn {0%{transform:scale(0.7); opacity:0;} 100%{transform:none;opacity:1;}}
    .matching-wait-msg {
      font-size: 1.47rem;
      font-weight: 900;
      color: #ae63be;
      text-align: center;
      margin-bottom: 13px;
      letter-spacing: 1.7px;
      background: none;
    }
    .matching-sub-msg {
      color: #bfa6cd;
      font-size: 1.17rem;
      text-align: center;
      margin-bottom: 8px;
      animation: fadeIn 1s;
      background: none;
    }
    .spinner {
      margin: 36px auto 12px auto;
      border: 8px solid #e6d4fc;
      border-top: 8px solid #b56edc;
      border-radius: 50%;
      width: 70px; height: 70px;
      animation: spin 1.2s linear infinite;
      background: none;
    }
    @keyframes spin {0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);}}

    /* ì±„íŒ…ë°©ë§Œ í° ë°°ê²½ */
    #chat-div {
      max-width: 700px;
      min-width: 480px;
      min-height: 500px;
      margin-top: 0;
      animation: fadeInUp 1s cubic-bezier(.13,.73,.61,.91);
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      background: #fff;
      border-radius: 2.1rem;
      box-shadow: 0 11px 48px 0 #bda4e944, 0 3px 18px 0 #ffe3ee0c;
      padding: 0;
      border: 1.5px solid #ebe6f6;
    }
    #chat-box {
      flex: 1 1 auto;
      width: 100%;
      min-height: 350px;
      max-height: 450px;
      background: none;
      overflow-y: auto;
      padding: 44px 70px 18px 70px;
      font-size: 1.23rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      box-sizing: border-box;
      scroll-behavior: smooth;
    }
    .chat-row {
      display: flex;
      margin-bottom: 20px;
      align-items: flex-end;
      width: 100%;
    }
    .chat-row.me { justify-content: flex-end; }
    .chat-row.you { justify-content: flex-start; }
    .bubble {
      display: inline-block;
      max-width: 68%;
      padding: 18px 33px 16px 21px;
      font-size: 1.17rem;
      border-radius: 1.8rem 1.8rem 1.8rem 1.2rem;
      background: #ece7f6;
      color: #353153;
      position: relative;
      font-weight: 500;
      box-shadow: 0 2px 14px 0 #e5d8fa17;
      word-break: break-word;
      line-height: 1.7;
      transition: background .14s;
      animation: bubbleIn 0.22s;
      backdrop-filter: blur(4px);
    }
    .chat-row.me .bubble {
      background: linear-gradient(98deg, #764ba2 0%, #b56edc 93%);
      color: #fff;
      border-radius: 1.8rem 1.8rem 1.2rem 1.8rem;
      margin-left: 34px;
      margin-right: 0;
      box-shadow: 0 7px 22px 0 #a786e916;
      animation: bubbleInRight 0.18s;
      backdrop-filter: blur(3px);
    }
    .chat-row.you .bubble {
      margin-right: 34px;
      margin-left: 0;
    }
    @keyframes bubbleIn {0% {opacity:0; transform:scale(0.94);} 100% {opacity:1;transform:none;}}
    @keyframes bubbleInRight {0% {opacity:0; transform:translateX(30px) scale(0.93);} 100%{opacity:1;transform:none;}}
    .bubble .sender {
      font-size: 1.11rem;
      font-weight: 900;
      margin-bottom: 2px;
      display: block;
      color: #b56edc;
      margin-bottom: 7px;
      letter-spacing: 0.45px;
    }
    .chat-row.me .bubble .sender { color: #ffe3ee;}
    .bubble .time {
      font-size: 1.01rem;
      color: #b4aad0;
      margin-left: 11px;
      margin-top: 10px;
      float: right;
      font-weight: 400;
    }
    .chat-input-bar {
      width: 100%;
      display: flex;
      gap: 18px;
      align-items: center;
      padding: 20px 62px 32px 62px;
      box-sizing: border-box;
      background: none;
      position: relative;
    }
    #message-input {
      flex: 1 1 auto;
      border-radius: 1.3rem;
      border: 1.5px solid #e0d3ff;
      background: #fff;
      font-size: 1.22rem;
      padding: 15px 27px;
      font-family: inherit;
      transition: border-color 0.17s, box-shadow 0.13s;
      font-weight: 500;
      box-shadow: 0 1px 6px 0 #d8c8f51f;
      margin: 0;
    }
    #message-input:focus {
      border-color: #b56edc;
      box-shadow: 0 0 7px #b56edc34;
      outline: none;
    }
    #sendBtn {
      background: linear-gradient(98deg, #b56edc 0%, #ffb6b9 100%);
      color: #fff;
      border: none;
      font-weight: 800;
      font-size: 1.21rem;
      border-radius: 1.5rem;
      padding: 0.9rem 2.2rem;
      box-shadow: 0 2px 13px #e4b6ff1b;
      cursor: pointer;
      transition: background 0.14s, box-shadow 0.13s, transform 0.13s;
    }
    #sendBtn:hover { background: linear-gradient(93deg, #ffb6b9 0%, #b56edc 100%); transform: scale(1.04);}
    #sendBtn:disabled { background: #e4d8ee; color: #fff; opacity: 0.63;}
    #leaveBtn {
      background: linear-gradient(93deg, #b56edc 0%, #fca3b9 100%);
      color: #fff;
      font-weight: 800;
      border: none;
      font-size: 1.11rem;
      border-radius: 1.5rem;
      padding: 0.9rem 1.7rem;
      margin-left: 3px;
      box-shadow: 0 2px 12px #e4b6ff15;
      cursor: pointer;
      transition: background 0.14s, box-shadow 0.13s, transform 0.13s;
    }
    #leaveBtn:hover { background: linear-gradient(93deg, #fca3b9 0%, #b56edc 100%); transform: scale(1.04);}
    .system-message {
      color: #b4aad0;
      font-style: italic;
      font-size: 1.12rem;
      text-align: center;
      padding: 12px 0;
      letter-spacing: 0.3px;
      animation: fadeIn 0.6s;
      width: 100%;
      margin: 9px auto 8px auto;
      display: block;
    }
  </style>
</head>

<body>
  <div id="particles-js"></div>

  <div class="main-wrap">
      <div class="center-content">
        <div class="mini-title">ì¹œêµ¬ ëœë¤ ë§¤ì¹­ ì±„íŒ…</div>

        <div id="match-div">
          <button id="matchBtn">ì¹œêµ¬ ëœë¤ ë§¤ì¹­ ì‹œì‘!</button>
        </div>

        <div id="matching-div" style="display: none;">
          <div class="matching-wait-icon">ğŸ¤</div>
          <div class="matching-wait-msg">ì¹œêµ¬ë¥¼ ì°¾ëŠ” ì¤‘...</div>
          <div class="matching-sub-msg">ìƒˆë¡œìš´ ì¹œêµ¬ì™€ ëŒ€í™”í•  ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.<br/>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!</div>
          <div class="spinner"></div>
        </div>

        <div id="chat-div" style="display: none;">
          <div id="chat-box"></div>

          <form class="chat-input-bar" autocomplete="off" id="chatForm">
            <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
            <button type="submit" id="sendBtn" disabled>ì „ì†¡</button>
            <button type="button" id="leaveBtn">ë‚˜ê°€ê¸°</button>
          </form>
        </div>
      </div>
    </div>

	<script th:inline="javascript">
	  // âœ… ì„œë²„(ì„¸ì…˜)ì—ì„œ ì£¼ì…ë˜ëŠ” "ë‚´ ì•„ì´ë””"
	  // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ model.addAttribute("myUserId", ì„¸ì…˜ê°’) ê¼­ ë„£ì–´ì¤˜ì•¼ í•¨!
	  const MY_USER_ID = /*[[${myUserId}]]*/ null;
	</script>

	<script>
	  // ------------------ íŒŒí‹°í´ ë°°ê²½ ì„¤ì • ------------------
	  particlesJS("particles-js", {
	    particles: {
	      number: { value: 19, density: { enable: true, value_area: 800 } },
	      color: { value: ["#c1b1e6", "#fff", "#fae6f2", "#f9eaff"] },
	      shape: { type: "circle" },
	      opacity: { value: 0.19, random: true },
	      size: { value: 35, random: true },
	      line_linked: { enable: false },
	      move: { enable: true, speed: 0.28, direction: "top-right", random: true, straight: false, out_mode: "out", bounce: false }
	    },
	    interactivity: { detect_on: "canvas", events: { onhover: { enable: false }, onclick: { enable: false }, resize: true } },
	    retina_detect: true
	  });

	  // ------------------ URLì—ì„œ ë§¤ì¹­ ì¡°ê±´ ì½ê¸° ------------------
	  const params = new URLSearchParams(location.search);
	  const selectedSchoolYear = params.get("schoolYear"); // "1" ~ "4"
	  const selectedMajor = params.get("major");           // ex) "ì»´í“¨í„°ê³µí•™ê³¼"
	  const sameAll = params.get("sameAll");               // "1" or "0" (í˜¹ì€ null)

	  // ------------------ ì±„íŒ…/ë§¤ì¹­ ë¡œì§ ------------------
	  let stompClient = null;
	  let matchId = null;
	  let roomId = null;
	  
	  // âœ… ë§¤ì¹­ ì„±ê³µ ì—°ì¶œìš©
	  let matchedDelayTimer = null;
	  const MATCHED_DELAY_MS = 2300; // 1000~2000 ì‚¬ì´ë¡œ ì·¨í–¥ëŒ€ë¡œ

	  function showMatchedOverlay() {
	    // matchingDivë¥¼ "ì„±ê³µ" í™”ë©´ìœ¼ë¡œ ë°”ê¿”ì¹˜ê¸°
	    matchingDiv.innerHTML = `
	      <div class="matching-wait-icon">âœ…</div>
	      <div class="matching-wait-msg">ë§¤ì¹­ ì„±ê³µ!</div>
	      <div class="matching-sub-msg">ê³§ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤...</div>
	      <div class="spinner" style="opacity:.35;"></div>
	    `;
	  }

	  function goChatAfterDelay(mId) {
	    // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
	    if (matchedDelayTimer) return;

	    showMatchedOverlay();

	    matchedDelayTimer = setTimeout(() => {
	      matchedDelayTimer = null;
	      onMatched(mId);
	    }, MATCHED_DELAY_MS);
	  }

	  // âœ… í•µì‹¬: ë‚´ ì•„ì´ë””ë¥¼ "ì„œë²„ ì£¼ì…ê°’"ìœ¼ë¡œ ê³ ì •
	  let myUserId = MY_USER_ID;

	  let isMatching = false;
	  let matchTimer = null;
	  let matchAbort = null;

	  const matchBtn = document.getElementById("matchBtn");
	  const matchDiv = document.getElementById("match-div");
	  const matchingDiv = document.getElementById("matching-div");
	  const chatDiv = document.getElementById("chat-div");
	  const sendBtn = document.getElementById("sendBtn");
	  const leaveBtn = document.getElementById("leaveBtn");
	  const messageInput = document.getElementById("message-input");
	  const chatForm = document.getElementById("chatForm") || document.querySelector("form.chat-input-bar");

	  function show(el) { el.style.display = "flex"; }
	  function hide(el) { el.style.display = "none"; }

	  function requireQuery() {
	    if (!selectedSchoolYear || !selectedMajor) {
	      matchingDiv.innerHTML =
	        "<div class='system-message' style='color:red;'>ë§¤ì¹­ ì¡°ê±´(í•™ë…„/í•™ê³¼)ì´ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§¤ì¹­ ì¡°ê±´ ì„ íƒ í™”ë©´ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•´ ì£¼ì„¸ìš”.</div>";
	      return false;
	    }
	    return true;
	  }

	  // âœ… ë‚´ ì•„ì´ë””ê°€ ì„œë²„ì—ì„œ ì•ˆ ë“¤ì–´ì˜¤ë©´ ë°”ë¡œ ì•ˆë‚´ (ì—¬ê¸°ì„œ ë§‰ì•„ì¤˜ì•¼ í—·ê°ˆë¦¼ ì—†ìŒ)
	  function requireLoginUserId() {
	    if (!myUserId) {
	      matchingDiv.innerHTML =
	        "<div class='system-message' style='color:red;'>ë‚´ ì‚¬ìš©ì ì•„ì´ë””ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ë¡œê·¸ì¸/ì„¸ì…˜ í™•ì¸ í•„ìš”)</div>";
	      return false;
	    }
	    return true;
	  }

	  // ------------------ (1) ë§¤ì¹­ ì‹œì‘ ------------------
	  matchBtn.addEventListener("click", async () => {
	    if (isMatching) return;
	    isMatching = true;

	    matchBtn.disabled = true;
	    hide(matchDiv);
	    show(matchingDiv);

	    try {
	      if (!requireQuery()) {
	        isMatching = false;
	        matchBtn.disabled = false;
	        return;
	      }
	      if (!requireLoginUserId()) {
	        isMatching = false;
	        matchBtn.disabled = false;
	        return;
	      }

	      const res = await fetch(
	        `/api/matches/create?schoolYear=${encodeURIComponent(selectedSchoolYear)}&major=${encodeURIComponent(selectedMajor)}&sameAll=${encodeURIComponent(sameAll ?? "0")}`,
	        { method: "POST", cache: "no-store", headers: { "Accept": "application/json" } }
	      );

	      if (res.status === 401) throw new Error("LOGIN_REQUIRED");
	      if (!res.ok) {
	        const t = await res.text().catch(() => "");
	        throw new Error("CREATE_FAILED: " + res.status + " " + t);
	      }

	      const data = await res.json();
	      if (!data) throw new Error("NO_MATCH");

	      matchId = data.matchId ?? data.match_id ?? data.id;
	      if (!matchId) throw new Error("MATCH_ID_MISSING");

	      const status = data.status;

		  if (status === "MATCHED") {
		    isMatching = false;
		    stopStatusPolling();
		    goChatAfterDelay(matchId);   // âœ… ë³€ê²½
		  } else {
		    startStatusPolling();
		  }

	    } catch (err) {
	      console.error("ë§¤ì¹­ ì‹œì‘ ì˜¤ë¥˜:", err);

	      isMatching = false;
	      stopStatusPolling();

	      let msg = "ë§¤ì¹­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
	      if (String(err.message).includes("LOGIN_REQUIRED")) msg = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
	      if (String(err.message).includes("NO_MATCH")) msg = "í˜„ì¬ ë§¤ì¹­ ê°€ëŠ¥í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.";

	      matchingDiv.innerHTML = `<div class='system-message' style='color:red;'>${msg}</div>`;
	      matchBtn.disabled = false;
	    }
	  });

	  // ------------------ (2) status í´ë§ ------------------
	  function startStatusPolling() {
	    stopStatusPolling();
	    pollStatusOnce();
	  }

	  function stopStatusPolling() {
	    if (matchTimer) { clearTimeout(matchTimer); matchTimer = null; }
	    if (matchAbort) { matchAbort.abort(); matchAbort = null; }
	  }

	  async function pollStatusOnce() {
	    if (!isMatching) return;
	    if (!matchId) return;

	    try {
	      matchAbort = new AbortController();

	      const res = await fetch(`/api/matches/status?matchId=${encodeURIComponent(matchId)}`, {
	        method: "GET",
	        cache: "no-store",
	        headers: { "Accept": "application/json" },
	        signal: matchAbort.signal
	      });

	      if (!res.ok) {
	        const t = await res.text().catch(() => "");
	        throw new Error("STATUS_FAILED: " + res.status + " " + t);
	      }

	      const data = await res.json();
	      const status = data.status;

		  if (status === "MATCHED") {
		    isMatching = false;
		    stopStatusPolling();
		    goChatAfterDelay(matchId);   // âœ… ë³€ê²½
		    return;
		  }

	      matchTimer = setTimeout(pollStatusOnce, 900);

	    } catch (err) {
	      if (err && err.name === "AbortError") return;

	      console.error("ë§¤ì¹­ ìƒíƒœ í´ë§ ì˜¤ë¥˜:", err);

	      isMatching = false;
	      stopStatusPolling();

	      matchingDiv.innerHTML =
	        "<div class='system-message' style='color:red;'>ë§¤ì¹­ ìƒíƒœ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>";
	      matchBtn.disabled = false;
	    }
	  }

	  // ------------------ (3) ë§¤ì¹­ ì™„ë£Œ ------------------
	  function onMatched(mId) {
	    roomId = mId;

	    hide(matchingDiv);
	    show(chatDiv);

	    connectToChatRoom();
	    messageInput.focus();
	  }

	  // ------------------ (4) STOMP ì—°ê²° ------------------
	  function connectToChatRoom() {
	    const socket = new SockJS("/ws-chat");
	    stompClient = Stomp.over(socket);
	    stompClient.debug = null;

	    stompClient.connect({}, () => {
	      stompClient.subscribe("/topic/chat/" + roomId, (msg) => {
	        const data = JSON.parse(msg.body);

	        if (data.text === "LEAVE" && myUserId && data.senderId !== myUserId) {
	          appendSystemMessage("ìƒëŒ€ë°©ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
	          sendBtn.disabled = true;
	          return;
	        }

	        appendChatMessage(data);
	      });

	      sendBtn.disabled = false;
	    }, () => {
	      appendSystemMessage("ì±„íŒ… ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
	    });
	  }

	  // ------------------ (5) ë©”ì‹œì§€ ì „ì†¡ ------------------
	  chatForm.addEventListener("submit", (e) => {
	    e.preventDefault();
	    sendChatMessage();
	  });

	  function sendChatMessage() {
	    const content = messageInput.value.trim();
	    if (!content || !stompClient || !stompClient.connected) return;

	    const now = new Date();
	    const hh = now.getHours().toString().padStart(2, "0");
	    const mm = now.getMinutes().toString().padStart(2, "0");
	    const timeStr = `${hh}:${mm}`;

	    const chatMessage = { senderId: myUserId, text: content, timestamp1: timeStr };
	    stompClient.send("/app/chat/" + roomId, {}, JSON.stringify(chatMessage));

	    messageInput.value = "";
	    messageInput.focus();
	  }

	  // ------------------ (6) í™”ë©´ ì¶œë ¥ ------------------
	  function appendChatMessage(msg) {
	    const chatBox = document.getElementById("chat-box");
	    const row = document.createElement("div");

	    const time = msg.timestamp1 || "";
	    const isMe = (myUserId && msg.senderId === myUserId);
	    row.className = "chat-row " + (isMe ? "me" : "you");

	    const sender = isMe ? "ë‚˜" : "ìµëª…";
	    row.innerHTML = `
	      <div class="bubble">
	        <span class="sender">${sender}</span>
	        <span class="text">${escapeHtml(msg.text ?? "")}</span>
	        <span class="time">${escapeHtml(time)}</span>
	      </div>
	    `;
	    chatBox.appendChild(row);
	    chatBox.scrollTop = chatBox.scrollHeight;
	  }

	  function appendSystemMessage(msg) {
	    const chatBox = document.getElementById("chat-box");
	    const div = document.createElement("div");
	    div.className = "system-message";
	    div.textContent = msg;
	    chatBox.appendChild(div);
	    chatBox.scrollTop = chatBox.scrollHeight;
	  }

	  function escapeHtml(str) {
	    return String(str)
	      .replaceAll("&", "&amp;")
	      .replaceAll("<", "&lt;")
	      .replaceAll(">", "&gt;")
	      .replaceAll('"', "&quot;")
	      .replaceAll("'", "&#039;");
	  }

	  // ------------------ (7) ë‚˜ê°€ê¸° ------------------
	  leaveBtn.addEventListener("click", async () => {
		if (matchedDelayTimer) { clearTimeout(matchedDelayTimer); matchedDelayTimer = null; }
	    isMatching = false;
	    stopStatusPolling();

	    // âœ… DB ìƒíƒœ ENDED ì²˜ë¦¬(ì¬ë§¤ì¹­ ê¼¬ì„ ë°©ì§€)
	    if (matchId) {
	      try {
	        await fetch(`/api/matches/${encodeURIComponent(matchId)}/leave`, {
	          method: "PUT",
	          cache: "no-store",
	          headers: { "Accept": "application/json" }
	        });
	      } catch (e) {
	        console.error("leave API ì‹¤íŒ¨:", e);
	      }
	    }

	    // STOMP ì•Œë¦¼ + ì¢…ë£Œ
	    try {
	      if (stompClient && stompClient.connected) {
	        stompClient.send("/app/chat/" + roomId + "/leave", {}, JSON.stringify({ senderId: myUserId }));
	        stompClient.disconnect();
	      }
	    } catch (e) {}

	    location.reload();
	  });

	  window.addEventListener("beforeunload", () => {
	    isMatching = false;
	    stopStatusPolling();
	    try {
	      if (stompClient && stompClient.connected) {
	        stompClient.send("/app/chat/" + roomId + "/leave", {}, JSON.stringify({ senderId: myUserId }));
	        stompClient.disconnect();
	      }
	    } catch (e) {}
	  });
	</script>

  </body>
  </html>